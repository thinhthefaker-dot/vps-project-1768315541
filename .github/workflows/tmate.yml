name: Create VPS (Auto Restart)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

env:
  VPS_NAME: vps-project-1768315541
  TMATE_SERVER: nyc1.tmate.io
  GITHUB_TOKEN_VPS: ${{ secrets.GH_TOKEN }}

jobs:
  deploy:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: ‚¨áÔ∏è Checkout source
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}

    - name: üêç T·∫°o file VPS info
      run: |
        mkdir -Force links
        "VPS kh·ªüi t·∫°o - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File -FilePath "links/vps-project-1768315541.txt" -Encoding UTF8

    - name: üñ•Ô∏è C√†i ƒë·∫∑t v√† ch·∫°y TightVNC, noVNC, Cloudflared
      shell: pwsh
      run: |
        Write-Host "üì• Installing TightVNC, noVNC, and Cloudflared..."
        
        try {
          Write-Host "üì• Installing TightVNC..."
          Invoke-WebRequest -Uri "https://www.tightvnc.com/download/2.8.63/tightvnc-2.8.63-gpl-setup-64bit.msi" -OutFile "tightvnc-setup.msi" -TimeoutSec 60
          Write-Host "‚úÖ TightVNC downloaded"
          
          Start-Process msiexec.exe -Wait -ArgumentList '/i tightvnc-setup.msi /quiet /norestart ADDLOCAL="Server" SERVER_REGISTER_AS_SERVICE=1 SERVER_ADD_FIREWALL_EXCEPTION=1 SET_USEVNCAUTHENTICATION=1 VALUE_OF_USEVNCAUTHENTICATION=1 SET_PASSWORD=1 VALUE_OF_PASSWORD=phongdz SET_ACCEPTHTTPCONNECTIONS=1 VALUE_OF_ACCEPTHTTPCONNECTIONS=1 SET_ALLOWLOOPBACK=1 VALUE_OF_ALLOWLOOPBACK=1'
          Write-Host "‚úÖ TightVNC installed"
          
          Write-Host "üîß Enabling loopback connections in TightVNC registry..."
          Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AllowLoopback" -Value 1 -ErrorAction SilentlyContinue
          
          Write-Host "üîç Stopping any existing tvnserver processes..."
          Stop-Process -Name "tvnserver" -Force -ErrorAction SilentlyContinue
          Stop-Service -Name "tvnserver" -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
          
          Write-Host "üöÄ Starting TightVNC server..."
          Start-Process -FilePath "C:\Program Files\TightVNC\tvnserver.exe" -ArgumentList "-run -localhost no" -WindowStyle Hidden
          Start-Sleep -Seconds 20
          
          netsh advfirewall firewall add rule name="Allow VNC 5900" dir=in action=allow protocol=TCP localport=5900
          netsh advfirewall firewall add rule name="Allow noVNC 6080" dir=in action=allow protocol=TCP localport=6080
          Write-Host "‚úÖ Firewall rules added"
          
          Write-Host "üì• Installing Python dependencies for noVNC and websockify..."
          python -m pip install --upgrade pip
          pip install novnc websockify==0.13.0
          
          Write-Host "üì• Installing Cloudflared..."
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe" -TimeoutSec 60
          Write-Host "‚úÖ Cloudflared downloaded"
          
          Write-Host "üöÄ Starting websockify..."
          $novncPath = (pip show novnc | Select-String "Location: (.*)").Matches.Groups[1].Value + "\novnc"
          if (-not (Test-Path "$novncPath/vnc.html")) {
            Write-Host "üì• Downloading noVNC..."
            $novncVersion = "v1.6.0"
            Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/tags/$novncVersion.zip" -OutFile "noVNC.zip" -TimeoutSec 60
            Expand-Archive -Path "noVNC.zip" -DestinationPath "." -Force
            Move-Item -Path "noVNC-$($novncVersion.Substring(1))" -Destination "noVNC" -Force
            $novncPath = "noVNC"
          }
          Start-Process -FilePath "python" -ArgumentList "-m", "websockify", "6080", "127.0.0.1:5900", "--web", "$novncPath" -WindowStyle Hidden
          Start-Sleep -Seconds 10
          
          Write-Host "üåê Starting Cloudflared tunnel..."
          Start-Process -FilePath "cloudflared.exe" -ArgumentList "tunnel", "--url", "http://localhost:6080", "--no-autoupdate" -WindowStyle Hidden
          Start-Sleep -Seconds 20
          
          Write-Host "üåê Retrieving Cloudflared URL..."
          $maxAttempts = 60
          $attempt = 0
          $cloudflaredUrl = ""
          
          do {
            $attempt++
            Write-Host "üîÑ Checking Cloudflared URL (attempt $attempt/$maxAttempts)"
            Start-Sleep -Seconds 2
            
            $processes = Get-Process -Name "cloudflared" -ErrorAction SilentlyContinue
            if ($processes) {
              $logContent = Get-Content "cloudflared.log" -Raw -ErrorAction SilentlyContinue
              if ($logContent -match 'https://[a-zA-Z0-9-]+\.trycloudflare\.com') {
                $cloudflaredUrl = $matches[0]
                Write-Host "‚úÖ Found Cloudflared URL: $cloudflaredUrl"
                break
              }
            }
          } while ($attempt -lt $maxAttempts)
          
          if ($cloudflaredUrl) {
            $remoteLink = "$cloudflaredUrl/vnc.html"
            Write-Host "üåå Remote VNC URL: $remoteLink"
            
            $remoteLink | Out-File -FilePath "remote-link.txt" -Encoding UTF8 -NoNewline
            
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git config --global user.name "github-actions[bot]"
            git add remote-link.txt
            git commit -m "üîó Updated remote-link.txt - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" --allow-empty
            git push origin main
            Write-Host "‚úÖ Remote link committed and pushed"
          } else {
            Write-Host "‚ùå Failed to retrieve Cloudflared URL after max attempts"
            exit 1
          }
        } catch {
          Write-Host "‚ùå Setup failed: $_"
          exit 1
        }
        
        Write-Host "üöÄ VPS Session Started - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host "üåå Access noVNC via remote-link.txt URL (Password: phongdz)"
        
        mkdir -Force ".backup"
        
        $totalMinutes = 330
        $restartCheckpoint = 320
        
        for ($i = 1; $i -le $totalMinutes; $i++) {
          $currentTime = Get-Date -Format 'HH:mm:ss'
          Write-Host "üü¢ VPS Running - Minute $i/$totalMinutes ($currentTime)"
          
          if ($i -eq $restartCheckpoint) {
            Write-Host "üîÅ Preparing restart in $($totalMinutes - $i) minutes..."
          }
          
          Start-Sleep -Seconds 60
        }
        
        Write-Host "‚è∞ VPS session completed. Preparing restart..."

    - name: üîÑ Auto Restart Workflow
      if: always()
      run: |
        $lockFile = "restart.lock"
        $currentTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        
        "RESTART_$(Get-Date -Format 'yyyyMMdd_HHmmss')" | Out-File -FilePath $lockFile -Encoding UTF8
        
        Write-Host "üîÅ Initiating workflow restart at $currentTime"
        
        try {
          Stop-Process -Name "cloudflared" -Force -ErrorAction SilentlyContinue
          Stop-Process -Name "python" -Force -ErrorAction SilentlyContinue
          Stop-Process -Name "tvnserver" -Force -ErrorAction SilentlyContinue
        } catch {
          Write-Host "‚ö†Ô∏è Process cleanup failed: $_"
        }
        
        Start-Sleep -Seconds 10
        
        try {
          $headers = @{ "Accept" = "application/vnd.github+json"; "Authorization" = "Bearer $env:GITHUB_TOKEN_VPS"; "Content-Type" = "application/json"; "X-GitHub-Api-Version" = "2022-11-28" }
          
          $payload = @{ event_type = "create-vps"; client_payload = @{ vps_name = "vps-project-1768315541"; restart_time = $currentTime; auto_restart = $true } } | ConvertTo-Json -Depth 2
          
          Invoke-RestMethod -Uri "https://api.github.com/repos/thinhthefaker-dot/vps-project-1768315541/dispatches" -Method Post -Headers $headers -Body $payload -TimeoutSec 30
          Write-Host "‚úÖ Workflow restart triggered"
          
          git add $lockFile
          git commit -m "üîÑ Auto restart - $currentTime" --allow-empty
          git push origin main
          
        } catch {
          Write-Host "‚ùå Restart failed: $_"
          Remove-Item $lockFile -Force -ErrorAction SilentlyContinue
          exit 1
        }
